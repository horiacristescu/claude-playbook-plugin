#!/bin/bash
# session-start-hook
# SessionStart hook â€” persists session_id as PLAYBOOK_SESSION_ID env var.
#
# Uses CLAUDE_ENV_FILE to make the env var available in all subsequent
# Bash commands for the session. This enables per-session task state:
# each agent gets its own .agent/current_state.<session_id> file.
#
# Note: CLAUDE_ENV_FILE doesn't work in VSCode extension (as of Feb 2026).
# The PreToolUse hook (task-gate-hook) injects the env var via updatedInput
# as a fallback. This hook is kept for when CLAUDE_ENV_FILE works (CLI).

set -e

# Source shared lib (same directory)
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$HOOK_DIR/gate-echo-lib.sh"

# Parse session_id from stdin JSON
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('session_id',''))" 2>/dev/null)

if [ -z "$SESSION_ID" ]; then
    exit 0
fi

# Write to CLAUDE_ENV_FILE so it persists for all Bash calls this session
if [ -n "$CLAUDE_ENV_FILE" ]; then
    echo "export PLAYBOOK_SESSION_ID=$SESSION_ID" >> "$CLAUDE_ENV_FILE"
fi

# Auto-provision .claude/bin/ wrappers for playbook projects
PROJECT_DIR=$(find_project_root)
if [ -n "$PROJECT_DIR" ]; then
    create_wrapper "$PROJECT_DIR" tasks
    create_wrapper "$PROJECT_DIR" sandbox
fi

exit 0
