#!/bin/bash
# session-end-hook
# SessionEnd hook — cleans up per-session state file.
#
# Parses session_id from stdin JSON, deletes .agent/current_state.<session_id>.

set -e

# Source shared lib (same directory)
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$HOOK_DIR/gate-echo-lib.sh"

# Find project root
PROJECT_DIR=$(find_project_root)
if [ -z "$PROJECT_DIR" ]; then
    exit 0
fi

# Skip cleanup if .agent/ isn't writable (sandbox mode)
if ! agent_dir_writable "$PROJECT_DIR"; then
    exit 0
fi

# Read stdin (SessionEnd JSON) — extract session_id
INPUT=$(cat)
SESSION_ID=$(echo "$INPUT" | python3 -c "import sys,json; print(json.loads(sys.stdin.read()).get('session_id',''))" 2>/dev/null || echo "")

if [ -z "$SESSION_ID" ]; then
    exit 0
fi

# Delete per-session state file if it exists
STATE_FILE="$PROJECT_DIR/.agent/current_state.$SESSION_ID"
LEGACY_FILE="$PROJECT_DIR/.agent/current_state"

# Delete per-session counter file
COUNTER_FILE="$PROJECT_DIR/.agent/.hook_counters.$SESSION_ID"
rm -f "$COUNTER_FILE"

if [ -f "$STATE_FILE" ]; then
    # Read task number before deleting, to compare with legacy file
    SESSION_TASK=$(cat "$STATE_FILE" 2>/dev/null | tr -d '[:space:]')
    rm -f "$STATE_FILE"

    # Also remove plain current_state if it holds the same task number
    # (prevents deleting another agent's active state)
    if [ -f "$LEGACY_FILE" ]; then
        LEGACY_TASK=$(cat "$LEGACY_FILE" 2>/dev/null | tr -d '[:space:]')
        if [ "$LEGACY_TASK" = "$SESSION_TASK" ]; then
            rm -f "$LEGACY_FILE"
        fi
    fi
fi

exit 0
